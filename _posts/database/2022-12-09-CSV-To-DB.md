---
layout: post
title: "[DB] ë„ì»¤ í™˜ê²½ì—ì„œ CSV íŒŒì¼ì—ì„œ DB ì €ì¥í•˜ëŠ” ë°©ë²•"
comments: true
categories : Database
tags : [Database, MariaDB]
date: 2022-12-09 14:00:00 +0900
---

## ì§ì ‘ sql ìƒì„±í•˜ì—¬ ì €ì¥í•˜ëŠ” ë°©ë²•

---

- ë„ì»¤ ì»¨í…Œì´ë„ˆ ìƒì„±ì‹œ ì´ˆê¸° ë°ì´í„° ë§Œë“¤ê¸°

- ë””ë ‰í† ë¦¬ **/docker-entrypoint-initdb.d/ì— .sql ë˜ëŠ” .sh íŒŒì¼ì„ ë„£ì–´ë‘ë©´ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì‹œ ì‹¤í–‰ëœë‹¤.**

- jpa.hibernate.ddl-auto:validate


- **@Transactionalì´ í¬í•¨ëœ ë©”ì†Œë“œê°€ í˜¸ì¶œë  ê²½ìš°, í”„ë¡ì‹œ ê°ì²´ë¥¼ ìƒì„±í•¨ìœ¼ë¡œì¨ íŠ¸ëœì­ì…˜ ìƒ ì„± ë° ì»¤ë°‹ ë˜ëŠ” ë¡¤ë°± í›„ íŠ¸ëœì­ì…˜ ë‹«ëŠ” ë¶€ìˆ˜ì ì¸ ì‘ì—…ì„ í”„ë¡ì‹œ ê°ì²´ì—ê²Œ ìœ„ì„**

- í”„ë¡ì‹œì˜ í•µì‹¬ì ì¸ ê¸°ëŠ¥ì€ ì§€ì •ëœ ë©”ì†Œë“œê°€ í˜¸ì¶œ(Invocation)ë  ë•Œ ì´ ë©”ì†Œë“œë¥¼ ê°€ë¡œì±„ì–´ ë¶€ê°€ ê¸°ëŠ¥ë“¤ì„ í”„ë¡ì‹œ ê°ì²´ì—ê²Œ ìœ„ì„

- ì¦‰, ê°œë°œìê°€ ë©”ì†Œë“œì— @Transactionalë§Œ ì„ ì–¸í•˜ê³ , ë¹„ì§€ë‹ˆìŠ¤ ë¡œì§ì— ì§‘ì¤‘ ê°€ëŠ¥!

> **ìŠ¤í”„ë§ AOP(Aspect-Oriented-Programming)**
>
> AOPë€ Aspect-oriented Programmingì˜ ì•½ì–´ë¡œ ìŠ¤í”„ë§ AOPëŠ” AOPì˜ êµ¬í˜„ì²´ë¥¼ ì œê³µí•˜ë©°, ìë°”ì— ë§Œë“¤ì–´ì ¸ ìˆëŠ” í”„ë ˆì„ì›Œí¬ AspectJ1ë¼ëŠ” ë˜ ë‹¤ë¥¸ êµ¬í˜„ì²´ì™€ ì—°ë™í•´ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ”
> ê¸°ëŠ¥ì„ ì œê³µí•œë‹¤. ì´ëŸ¬í•œ ê¸°ëŠ¥ì„ ê¸°ë°˜ìœ¼ë¡œ ìŠ¤í”„ë§ íŠ¸ëœì­ì…˜ê³¼ ê°™ì€ ë‹¤ë¥¸ ê¸°ëŠ¥ì´ ì ìš©ë˜ê³  ìˆë‹¤.
>
> ê·¸ë ‡ë‹¤ë©´ AOPëŠ” ì •í™•íˆ ë¬´ì—‡ì¼ê¹Œ? AOP, ê´€ì  ì§€í–¥ í”„ë¡œê·¸ë˜ë°ì€ í©ì–´ì§„ Aspectë¥¼ ëª¨ë“ˆí™” í•  ìˆ˜ ìˆëŠ” í”„ë¡œê·¸ë˜ë° ê¸°ë²•ì„ ë§í•œë‹¤. ê´€ì  ì§€í–¥ì€ ì–´ë–¤ ë¡œì§ì„ ê¸°ì¤€ìœ¼ë¡œ í•µì‹¬ì ì¸ ê´€ì , ë¶€ê°€ì ì¸ ê´€ì ìœ¼ë¡œ ë‚˜ëˆ„ì–´
> ë³¸ë‹¤ëŠ” ë§ì´ê³  ë”°ë¼ì„œ ê´€ì ì„ ê¸°ì¤€ìœ¼ë¡œ ê°ê° ëª¨ë“ˆí™”í•˜ëŠ” í”„ë¡œê·¸ë˜ë° ê¸°ë²•ì¸ ê²ƒì´ë‹¤. OOP(Object-oriented Programming, ê°ì²´ ì§€í–¥ í”„ë¡œê·¸ë˜ë°)ê³¼ ë‚˜ë€íˆ í•˜ëŠ”, ì„œë¡œ ë³´ì™„ê´€ê³„ì— ìˆëŠ” ê¸°ìˆ ì´ë‹¤.
>
> https://yadon079.github.io/2021/spring/spring-aop-core  
> [[10ë¶„ í…Œì½”í†¡] ğŸŒ•ì œì´ì˜ Spring AOP](https://www.youtube.com/watch?v=Hm0w_9ngDpM&ab_channel=%EC%9A%B0%EC%95%84%ED%95%9CTech)

<br>

## Spring Transactional ì£¼ì˜ì‚¬í•­

---

- https://tedblob.com/spring-aop-proxy/

- ìŠ¤í”„ë§ AOP ê¸°ë°˜ìœ¼ë¡œ í•˜ëŠ” ê¸°ëŠ¥ë“¤(@Transactional, @Cacheable, @Async) ì‚¬ìš©ì‹œ **Self Invocation ë¬¸ì œ**ë¡œ ì¸í•˜ì—¬ ì¥ì• ê°€ ë°œìƒí•  ìˆ˜ ìˆìŒ

- ë©”ì†Œë“œê°€ í˜¸ì¶œë˜ëŠ” ì‹œì ì— í”„ë¡ì‹œ ê°ì²´ë¥¼ ìƒì„±í•˜ê³ , í”„ë¡ì‹œ ê°ì²´ëŠ” ë¶€ê°€ ê¸°ëŠ¥(íŠ¸ëœì­ì…˜)ì„ ì£¼ì…í•´ ì¤€ë‹¤.

    - ì»´íŒŒì¼
    - í´ë˜ìŠ¤ ë¡œë“œì‹œ
    - í”„ë¡ì‹œ íŒ¨í„´

- ì™¸ë¶€ì—ì„œ bar() ë©”ì†Œë“œë¥¼ ì‹¤í–‰í•  ë•Œ ì •ìƒì ìœ¼ë¡œ í”„ë¡ì‹œê°€ ë™ì‘
  
- í•˜ì§€ë§Œ, @Transactionalì„ foo()ì—ë§Œ ì„ ì–¸í•˜ê³ , ì™¸ë¶€ì—ì„œ bar()ë¥¼ í˜¸ì¶œí•˜ê³ , bar() -> foo() í˜¸ì¶œí–ˆë‹¤ë©´?

![img](https://tedblob.com/wp-content/uploads/2021/08/Capture.png)

### Service

```java
@Slf4j
@Service
@Transactional(readOnly = true)
@RequiredArgsConstructor
public class PharmacyService {

    private final PharmacyRepository pharmacyRepository;

    // self invocation test
    public void bar(List<Pharmacy> pharmacyList) {
        log.info("bar CurrentTransactionName: " + TransactionSynchronizationManager.getCurrentTransactionName());
        foo(pharmacyList);
    }

    // self invocation test
    @Transactional
    public void foo(List<Pharmacy> pharmacyList) {
        log.info("foo CurrentTransactionName: " + TransactionSynchronizationManager.getCurrentTransactionName());
        pharmacyList.forEach(pharmacy -> {
            pharmacyRepository.save(pharmacy);
            throw new RuntimeException("throw error");
        });
    }
}
```

### Test(spock)

```java
@SpringBootTest
abstract class AbstractIntegrationContainerBaseTest extends Specification {

    static final GenericContainer MY_REDIS_CONTAINER

    static {
        // dockerì—ì„œ exposeí•œ port, hostì˜ portëŠ” testContainerê°€ ì„ì˜ë¡œ ì¶©ëŒ í•˜ì§€ ì•Šì€ í¬íŠ¸ë¥¼ ìƒì„±í•´ì„œ ë§¤í•‘í•¨
        MY_REDIS_CONTAINER = new GenericContainer<>("redis:6")
                .withExposedPorts(6379)

        MY_REDIS_CONTAINER.start()

        System.setProperty("spring.redis.host", MY_REDIS_CONTAINER.getHost())
        System.setProperty("spring.redis.port", MY_REDIS_CONTAINER.getMappedPort(6379).toString())
    }
}


class PharmacyServiceTest extends AbstractIntegrationContainerBaseTest {

    @Autowired
    private PharmacyService pharmacyService

    @Autowired
    private PharmacyRepository pharmacyRepository

    def setup() {
        pharmacyRepository.deleteAll()
    }
    
    def "self invocation"() {
        given:
        String address = "ì„œìš¸íŠ¹ë³„ì‹œ ì„±ë¶êµ¬ ë³´ë¬¸ë™"
        String name = "ê°€ê¹Œìš´ ì•½êµ­"
        double latitude = 37.58
        double longitude = 127.02

        def pharmacy = Pharmacy.builder()
                .pharmacyAddress(address)
                .pharmacyName(name)
                .latitude(latitude)
                .longitude(longitude)
                .build()

        when:
        pharmacyService.bar(Arrays.asList(pharmacy))

        then:
        def e = thrown(RuntimeException.class)
        def result = pharmacyService.findAll()
        result.size() == 1  // íŠ¸ëœì­ì…˜ì´ ì ìš©ë˜ì§€ ì•ŠëŠ”ë‹¤. (ë¡¤ë°±ì´ ì•ˆë¨)
    }
```
![img.png](https://user-images.githubusercontent.com/74996516/206626207-d9900f0e-d09c-4325-8952-ca53f5ca5baa.png)
ì™¸ë¶€ì—ì„œ í˜¸ì¶œì„ í•  ë•Œ **@Transactionalì´ ì•ˆ ê±¸ë ¤ìˆëŠ” ë©”ì„œë“œë¥¼ ì‹¤í–‰ í•˜ë©´**

**@Transactional ê±¸ë ¤ìˆëŠ” ë©”ì„œë“œë¥¼ ì‹¤í–‰í•˜ë”ë¼ë„** íŠ¸ëœì­ì…˜ì´ ì‘ë™í•˜ì§€ ì•ŠëŠ”ë‹¤.


## self invocation í•´ê²° ë°©ë²•

---

1. íŠ¸ëœì­ì…˜ ìœ„ì¹˜ë¥¼ ì™¸ë¶€ì—ì„œ í˜¸ì¶œí•˜ëŠ” bar() ë©”ì†Œë“œë¡œ ì´ë™
![img_1.png](https://user-images.githubusercontent.com/74996516/206626210-a4b605eb-d917-4e7a-a223-55d0ef23ab3d.png)
![img_3.png](https://user-images.githubusercontent.com/74996516/206626385-890ac577-0f98-4f32-b5a1-c9bbe8db51c4.png)

2. ê°ì²´ì˜ ì±…ì„ì„ ìµœëŒ€í•œ ë¶„ë¦¬í•˜ì—¬ ì™¸ë¶€ í˜¸ì¶œ í•˜ë„ë¡ ë¦¬í™í† ë§
   - service ë‚´ë¶€ì—ì„œë„ ì±…ì„ì„ ë¶„ë¦¬í•œë‹¤.

<br>

## Spring Transactional ì£¼ì˜ì‚¬í•­ (ì½ê¸° ì „ìš©)

---

- @Transactional(readOnly = true) ìŠ¤í”„ë§ì—ì„œ íŠ¸ëœì­ì…˜ì„ ì½ê¸° ì „ìš©ìœ¼ë¡œ ì„¤ì • ê°€ëŠ¥
  
- ì½ê¸° ì „ìš©ìœ¼ë¡œ ì„¤ì •í•˜ê²Œ ë˜ë©´, JPAì—ì„œ ìŠ¤ëƒ…ìƒ· ì €ì¥ ë° Dirty Checking ì‘ì—…ì„ ìˆ˜í–‰í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ì„±ëŠ¥ì ìœ¼ë¡œ ì´ì 
 
- ë”°ë¼ì„œ, Dirty Checking ë¶ˆê°€

- @Transactionalì€ ì ìš© ìš°ì„  ìˆœìœ„ë¥¼ ê°€ì§€ê³  ìˆìœ¼ë©°, í´ë˜ìŠ¤ ë³´ë‹¤ ë©”ì†Œë“œê°€ ìš°ì„ ìˆœìœ„ê°€ ë†’ë‹¤.

- í´ë˜ìŠ¤ì— @Transactioanl(readOnly=true) (ì½ê¸° ì „ìš©) ìœ¼ë¡œ ì ìš©í•´ ë†“ê³ , updateê°€ ë°œìƒí•˜ëŠ” ë©”ì†Œë“œì—ë§Œ readOnly=false ìš°ì„  ì ìš© (SimpleJpaRepository)

![img_2.png](https://user-images.githubusercontent.com/74996516/206626309-5f55a7a2-f2b0-4837-9ff1-6b75b44a1892.png)

